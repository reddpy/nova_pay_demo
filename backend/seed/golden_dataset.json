[
  {
    "inputs": {
      "question": "What's the rate limit on the payments API?",
      "context": "[Document 1: standards/api-design-guidelines.md]\n## Rate Limiting\n\nAll NovaPay APIs enforce a default rate limit of **500 requests per minute** per API key. Rate limit headers are included in every response:\n\n```\nX-RateLimit-Limit: 500\nX-RateLimit-Remaining: 423\nX-RateLimit-Reset: 1706140800\n```\n\nIndividual services may override this default with higher limits based on their specific requirements. Rate limit overrides must be documented in the service's API reference.\n\nWhen rate limited, the API returns `429 Too Many Requests` with a `Retry-After` header.\n\n## Authentication\n\nAll external APIs require authentication via API key in the `X-NovaPay-Key` header:\n\n```\nX-NovaPay-Key: sk_live_abc123...\n```\n\nInternal service-to-service calls use OAuth 2.0 client credentials flow (see [Auth Architecture](../architecture/auth-architecture.md)).\n\n---\n\n[Document 2: api/payments-api.md]\n# Payments API Reference\n\n*Last updated: January 2025*\n*Owner: Payments Team (`#team-payments`)*\n\nThe Payments API is NovaPay's core service for processing payment transactions. All payment operations go through this API.\n\n## Base URL\n\n- Production: `https://api.novapay.com/v2/payments`\n- Staging: `https://api.staging.novapay.internal/v2/payments`\n- Local dev: `http://localhost:8001/v2/payments`\n\n## Authentication\n\nAll requests require a valid API key in the `X-NovaPay-Key` header and a merchant ID in `X-Merchant-ID`.\n\n## Rate Limiting\n\nThe Payments API enforces a rate limit of **1000 requests per minute** per merchant. This is higher than our standard rate limit because payment processing is latency-sensitive and merchants often send bursts during peak hours. Rate limit headers are included in every response:\n\n```\nX-RateLimit-Limit: 1000\nX-RateLimit-Remaining: 847\nX-RateLimit-Reset: 1706140800\n```\n\nIf you exceed the rate limit, you'll receive a `429 Too Many Requests` response.\n\n---\n\n[Document 3: runbooks/payments-service-down.md]\n# Runbook: Payments Service Down\n\n*Owner: Payments Team (`#team-payments`)*\n*Severity: SEV-1 \u2014 All payment processing is halted*\n*Last tested: December 2024*\n\n## Symptoms\n\n- Datadog alert: `payments-api.health_check CRITICAL`\n- Merchants reporting `503 Service Unavailable` on payment endpoints\n- Dashboard showing spike in failed transactions\n- PagerDuty incident triggered for Payments on-call\n\n---\n\n[Document 4: api/users-api.md]\n## Pagination\n\nAll list endpoints use cursor-based pagination:\n```\nGET /v2/users/merchants?limit=20&cursor=eyJpZCI6MTIzfQ==\n```\n\n## Webhook Events\n\n- `merchant.verified` \u2014 KYC verification completed successfully\n- `merchant.rejected` \u2014 KYC verification failed\n- `merchant.suspended` \u2014 Merchant account suspended (compliance issue)\n- `team_member.invited` \u2014 New team member invited\n- `api_key.created` \u2014 New API key created\n- `api_key.revoked` \u2014 API key revoked\n\n## Important Notes\n\n- Merchant registration has a rate limit of 10 requests per hour per IP (to prevent abuse)\n- PII fields (SSN, EIN, bank account numbers) are encrypted at rest using AWS KMS\n- All user actions are audit-logged and retained for 7 years (regulatory requirement)"
    },
    "outputs": {
      "answer": "The Payments API has a rate limit of 1,000 requests per minute per merchant, while the API design guidelines list a default of 500 requests per minute per API key. These two documents give different numbers — the Payments API overrides the default, but you should be aware of the discrepancy."
    }
  },
  {
    "inputs": {
      "question": "What do I need to do before deploying?",
      "context": "[Document 1: processes/deployment-process.md]\n## Deployment Pipeline\n\n```\nCode Push \u2192 GitHub Actions (CI) \u2192 Build & Test \u2192 Container Image \u2192 ArgoCD (CD) \u2192 Kubernetes\n```\n\n### Step-by-Step\n\n1. **Push to feature branch** and open a Pull Request\n2. **CI runs automatically** (GitHub Actions):\n   - Linting (ESLint, golangci-lint, ruff)\n   - Unit tests\n   - Integration tests (against test database)\n   - Security scan (Snyk)\n   - Container image build\n3. **PR is reviewed and approved** (see separate code review guidelines)\n4. **Merge to `main`** triggers the deployment pipeline\n5. **ArgoCD detects the new image** and begins rollout:\n   - Staging is deployed first (automatic)\n   - Staging smoke tests run (5-minute window)\n   - Production deployment begins (canary rollout)\n6. **Canary rollout** (production):\n   - 10% of traffic goes to new version\n   - Monitor error rates and latency for 5 minutes\n   - If healthy: roll out to 50%, then 100%\n   - If unhealthy: automatic rollback\n\n---\n\n[Document 2: processes/deployment-process.md]\n## Environment Promotion\n\n| Environment | Trigger | Auto/Manual |\n|-------------|---------|-------------|\n| Development | Push to any branch | Automatic |\n| Staging | Merge to `main` | Automatic |\n| Production | Staging smoke tests pass | Automatic (canary) |\n\n## Deploy Schedule\n\n- Deploys can happen **anytime Monday through Thursday**\n- **Friday deploys are discouraged** \u2014 you need VP Engineering approval for Friday deploys\n- **No deploys during active incidents** (deployment pipeline is locked during SEV-1/SEV-2)\n- Hotfixes can bypass the schedule with team lead approval\n\n## Rollback\n\nIf a production deployment causes issues:\n\n```bash\n# Quick rollback via ArgoCD\nnovapay rollback <service-name>\n\n# Or via kubectl\nkubectl rollout undo deployment/<service-name> -n <namespace>\n```\n\nRollbacks take effect within 30 seconds.\n\n---\n\n[Document 3: onboarding/local-dev-setup.md]\n## Step 3: Set Up Local Services\n\n```bash\n# Start the local infrastructure stack (Postgres, Redis, Kafka, LocalStack)\ndocker-compose -f docker/docker-compose.local.yml up -d\n\n# Verify everything is running\nnovapay doctor\n```\n\nExpected output from `novapay doctor`:\n- PostgreSQL: `localhost:5432` \u2705\n- Redis: `localhost:6379` \u2705\n- Kafka: `localhost:9092` \u2705\n- LocalStack (S3/SQS): `localhost:4566` \u2705\n\n## Step 4: Seed the Database\n\n```bash\nnovapay db:migrate\nnovapay db:seed\n```\n\nThis creates test merchants and sample transaction data.\n\n## Step 5: Start Services\n\n```bash\n# Start all services in development mode\nnovapay dev\n\n# Or start specific services\nnovapay dev --service payments-api\nnovapay dev --service users-api\nnovapay dev --service gateway\n```\n\n## Service Ports (Local Dev)\n\n| Service | Port |\n|---------|------|\n| API Gateway | 8080 |\n| Payments API | 8001 |\n| Users API | 8002 |\n| Notifications API | 8003 |\n| Dashboard (frontend) | 3000 |\n| Admin Panel | 3001 |\n\n---\n\n[Document 4: processes/deployment-process.md]\n# Deployment Process\n\n*Last updated: December 2024*\n*Owner: Platform Team (`#team-platform`)*\n\n## Overview\n\nNovaPay uses a continuous deployment model with GitOps. All deployments go through our CI/CD pipeline \u2014 there are no manual deployments to production."
    },
    "outputs": {
      "answer": "Push to a feature branch, open a PR, and let CI run (linting, tests, security scan). Get the PR reviewed and approved, then merge to main. ArgoCD handles the rest: staging deploys automatically, smoke tests run, then production gets a canary rollout. Note that Friday deploys need VP Engineering approval, and deploys are blocked during active incidents."
    }
  },
  {
    "inputs": {
      "question": "How does our auth system work?",
      "context": "[Document 1: architecture/auth-architecture.md]\n## Auth v2 Architecture\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   Client     \u2502\u2500\u2500\u2500\u2500\u25b6\u2502  Auth v2     \u2502\u2500\u2500\u2500\u2500\u25b6\u2502   Token      \u2502\n\u2502 (Dashboard/  \u2502     \u2502  (OAuth      \u2502     \u2502   Store      \u2502\n\u2502  API)        \u2502\u25c0\u2500\u2500\u2500\u2500\u2502   Server)    \u2502\u25c0\u2500\u2500\u2500\u2500\u2502   (Redis)    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                            \u2502\n                     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                     \u2502  Users DB   \u2502\n                     \u2502 (Accounts)  \u2502\n                     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\n---\n\n[Document 2: architecture/auth-architecture.md]\n# Authentication Architecture\n\n*Last updated: January 2025*\n*Owner: Platform Team (`#team-platform`)*\n\n## Current State: Auth v2 (OAuth 2.0 + PKCE)\n\nAs of **Q3 2024**, NovaPay has migrated to **Auth v2**, a new authentication system based on **OAuth 2.0 with PKCE** (Proof Key for Code Exchange). Auth v1 (the legacy JWT-based system) was **deprecated in Q3 2024** and is scheduled for full decommission by **March 2025**.\n\n## Why We Migrated\n\nAuth v1 had several issues that motivated the migration:\n- JWT tokens were long-lived (24 hours) with no revocation mechanism\n- No support for fine-grained scopes \u2014 tokens were all-or-nothing\n- Session management was ad-hoc and inconsistent across services\n- No support for third-party OAuth integrations (merchants wanted \"Login with NovaPay\")\n\n---\n\n[Document 3: architecture/auth-architecture.md]\n### Key Components\n\n**OAuth 2.0 Server** (`auth-service` v2.x)\n- Built on top of `ory/fosite` (Go library)\n- Supports authorization code flow with PKCE (for dashboard)\n- Supports client credentials flow (for service-to-service)\n- Token endpoint: `https://auth.novapay.com/oauth/token`\n- Authorization endpoint: `https://auth.novapay.com/oauth/authorize`\n\n**Token Format**\n- Access tokens: Short-lived opaque tokens (15 minutes)\n- Refresh tokens: Long-lived, stored in Redis, rotated on each use\n- Tokens include scopes: `payments:read`, `payments:write`, `merchants:read`, `merchants:admin`\n\n**Token Validation**\n- Services validate tokens by calling the auth service's introspection endpoint\n- Results are cached locally for 60 seconds to reduce load\n- Endpoint: `https://auth.novapay.internal/oauth/introspect`\n\n---\n\n[Document 4: architecture/system-overview.md]\n### Auth v1 (JWT-based Authentication Service)\n- Handles authentication and session management\n- Issues JWT tokens for API access and dashboard sessions\n- Manages API key validation\n- Deployed as a shared service used by all APIs\n\n### Notifications Service (Python/FastAPI)\n- Sends emails (via SES), SMS (via Twilio), and webhook deliveries\n- Consumes events from Kafka and triggers appropriate notifications\n- Uses a template engine for consistent messaging"
    },
    "outputs": {
      "answer": "NovaPay uses Auth v2, based on OAuth 2.0 with PKCE, which replaced the legacy JWT-based Auth v1 in Q3 2024. Access tokens are short-lived (15 minutes) and opaque, refresh tokens are stored in Redis and rotated on use. The system supports authorization code flow with PKCE for the dashboard and client credentials for service-to-service calls. Note that the System Architecture Overview doc still references Auth v1 as current, but that information is stale — Auth v1 is deprecated and scheduled for decommission by March 2025."
    }
  },
  {
    "inputs": {
      "question": "How do I configure Stripe webhooks?",
      "context": "[Document 1: standards/api-design-guidelines.md]\n## Webhooks\n\nFor webhook delivery, follow these standards:\n- Sign payloads with HMAC-SHA256 using the merchant's webhook secret\n- Include a `NovaPay-Signature` header with the signature\n- Include a `NovaPay-Timestamp` header for replay protection\n- Retry failed deliveries with exponential backoff (see [Notifications API](../api/notifications-api.md))\n- Allow merchants to configure multiple webhook endpoints per event type\n\n## Documentation\n\nAll APIs must have:\n- OpenAPI 3.0 spec in the service's repo (`docs/openapi.yaml`)\n- Published documentation on the developer portal\n- Code examples in at least Python and JavaScript\n- A changelog documenting all changes per version\n\n---\n\n[Document 2: api/payments-api.md]\n## Webhooks\n\nPayment status changes trigger webhooks to the merchant's configured endpoint. Events include:\n- `payment.completed`\n- `payment.failed`\n- `payment.refunded`\n- `payment.disputed`\n\nWebhook payloads are signed with HMAC-SHA256 using the merchant's webhook secret.\n\n## Error Codes\n\n| Code | Meaning |\n|------|---------|\n| `INSUFFICIENT_FUNDS` | Card has insufficient funds |\n| `CARD_DECLINED` | Card was declined by issuer |\n| `INVALID_CURRENCY` | Unsupported currency code |\n| `DUPLICATE_PAYMENT` | Idempotency key already used |\n| `MERCHANT_SUSPENDED` | Merchant account is suspended |\n\n## SDK Examples\n\n```python\nfrom novapay import NovaPay\n\nclient = NovaPay(api_key=\"sk_live_...\")\npayment = client.payments.create(\n    amount=5000,\n    currency=\"USD\",\n    payment_method=\"card\"\n)\n```\n\n---\n\n[Document 3: api/users-api.md]\n## Pagination\n\nAll list endpoints use cursor-based pagination:\n```\nGET /v2/users/merchants?limit=20&cursor=eyJpZCI6MTIzfQ==\n```\n\n## Webhook Events\n\n- `merchant.verified` \u2014 KYC verification completed successfully\n- `merchant.rejected` \u2014 KYC verification failed\n- `merchant.suspended` \u2014 Merchant account suspended (compliance issue)\n- `team_member.invited` \u2014 New team member invited\n- `api_key.created` \u2014 New API key created\n- `api_key.revoked` \u2014 API key revoked\n\n## Important Notes\n\n- Merchant registration has a rate limit of 10 requests per hour per IP (to prevent abuse)\n- PII fields (SSN, EIN, bank account numbers) are encrypted at rest using AWS KMS\n- All user actions are audit-logged and retained for 7 years (regulatory requirement)\n\n---\n\n[Document 4: onboarding/local-dev-setup.md]\n## Step 3: Set Up Local Services\n\n```bash\n# Start the local infrastructure stack (Postgres, Redis, Kafka, LocalStack)\ndocker-compose -f docker/docker-compose.local.yml up -d\n\n# Verify everything is running\nnovapay doctor\n```\n\nExpected output from `novapay doctor`:\n- PostgreSQL: `localhost:5432` \u2705\n- Redis: `localhost:6379` \u2705\n- Kafka: `localhost:9092` \u2705\n- LocalStack (S3/SQS): `localhost:4566` \u2705\n\n## Step 4: Seed the Database\n\n```bash\nnovapay db:migrate\nnovapay db:seed\n```\n\nThis creates test merchants and sample transaction data.\n\n## Step 5: Start Services\n\n```bash\n# Start all services in development mode\nnovapay dev\n\n# Or start specific services\nnovapay dev --service payments-api\nnovapay dev --service users-api\nnovapay dev --service gateway\n```\n\n## Service Ports (Local Dev)\n\n| Service | Port |\n|---------|------|\n| API Gateway | 8080 |\n| Payments API | 8001 |\n| Users API | 8002 |\n| Notifications API | 8003 |\n| Dashboard (frontend) | 3000 |\n| Admin Panel | 3001 |"
    },
    "outputs": {
      "answer": "I don't have documentation on that topic."
    }
  },
  {
    "inputs": {
      "question": "How do I access the billing dashboard?",
      "context": "[Document 1: architecture/auth-architecture.md]\n## Local Development\n\nFor local dev, the auth service runs at `http://localhost:8010`. Use these test credentials:\n\n```\nClient ID: dev-dashboard-client\nClient Secret: dev-secret-12345\nTest User: admin@novapay.dev / password123\n```\n\nThese credentials only work in the local dev environment. Do not use them in staging or production.\n\n---\n\n[Document 2: architecture/data-pipeline.md]\n### Snowflake Data Warehouse\nOur analytics warehouse. Organized into three layers:\n\n| Schema | Purpose | Refresh |\n|--------|---------|---------|\n| `raw` | Direct mirror of S3 data | Continuous (Snowpipe) |\n| `staging` | Cleaned and transformed data | Every 15 minutes (dbt) |\n| `analytics` | Business-ready models | Every 15 minutes (dbt) |\n\n### dbt (Data Build Tool)\nAll transformations are managed with dbt. The dbt project lives in the `novapay-analytics` repo.\n\nKey models:\n- `fct_transactions` \u2014 Fact table for all payment transactions\n- `dim_merchants` \u2014 Merchant dimension table\n- `fct_daily_volume` \u2014 Daily transaction volume aggregates\n- `fct_merchant_health` \u2014 Merchant health scores (churn prediction)\n\n### Looker\nBusiness dashboards and self-serve analytics. Key dashboards:\n- **Executive Dashboard**: Daily GMV, transaction counts, success rates\n- **Merchant Health**: Per-merchant metrics and trends\n- **Operational**: System health, latency, error rates\n\n---\n\n[Document 3: runbooks/payments-service-down.md]\n# Runbook: Payments Service Down\n\n*Owner: Payments Team (`#team-payments`)*\n*Severity: SEV-1 \u2014 All payment processing is halted*\n*Last tested: December 2024*\n\n## Symptoms\n\n- Datadog alert: `payments-api.health_check CRITICAL`\n- Merchants reporting `503 Service Unavailable` on payment endpoints\n- Dashboard showing spike in failed transactions\n- PagerDuty incident triggered for Payments on-call\n\n---\n\n[Document 4: onboarding/local-dev-setup.md]\n## Step 3: Set Up Local Services\n\n```bash\n# Start the local infrastructure stack (Postgres, Redis, Kafka, LocalStack)\ndocker-compose -f docker/docker-compose.local.yml up -d\n\n# Verify everything is running\nnovapay doctor\n```\n\nExpected output from `novapay doctor`:\n- PostgreSQL: `localhost:5432` \u2705\n- Redis: `localhost:6379` \u2705\n- Kafka: `localhost:9092` \u2705\n- LocalStack (S3/SQS): `localhost:4566` \u2705\n\n## Step 4: Seed the Database\n\n```bash\nnovapay db:migrate\nnovapay db:seed\n```\n\nThis creates test merchants and sample transaction data.\n\n## Step 5: Start Services\n\n```bash\n# Start all services in development mode\nnovapay dev\n\n# Or start specific services\nnovapay dev --service payments-api\nnovapay dev --service users-api\nnovapay dev --service gateway\n```\n\n## Service Ports (Local Dev)\n\n| Service | Port |\n|---------|------|\n| API Gateway | 8080 |\n| Payments API | 8001 |\n| Users API | 8002 |\n| Notifications API | 8003 |\n| Dashboard (frontend) | 3000 |\n| Admin Panel | 3001 |"
    },
    "outputs": {
      "answer": "I don't have documentation on that topic."
    }
  },
  {
    "inputs": {
      "question": "What are the steps for local dev setup?",
      "context": "[Document 1: onboarding/local-dev-setup.md]\n# Local Development Setup\n\n*Last updated: January 2025*\n\nWelcome to NovaPay! This guide will get your local development environment up and running.\n\n## Prerequisites\n\n- macOS or Linux (Windows via WSL2 is supported but not recommended)\n- Docker Desktop 4.25+\n- Node.js 20 LTS\n- Python 3.11+\n- Go 1.21+ (for the payments-core service)\n- AWS CLI v2 configured with your `novapay-dev` profile\n\n## Step 1: Clone the Monorepo\n\n```bash\ngit clone git@github.com:novapay/novapay-platform.git\ncd novapay-platform\n```\n\n## Step 2: Install Dependencies\n\n```bash\n# Install the NovaPay CLI tool\nnpm install -g @novapay/cli@latest\n\n# Bootstrap all services\nnovapay bootstrap\n```\n\nThis will install dependencies for all services and set up local config files.\n\n---\n\n[Document 2: architecture/auth-architecture.md]\n## Local Development\n\nFor local dev, the auth service runs at `http://localhost:8010`. Use these test credentials:\n\n```\nClient ID: dev-dashboard-client\nClient Secret: dev-secret-12345\nTest User: admin@novapay.dev / password123\n```\n\nThese credentials only work in the local dev environment. Do not use them in staging or production.\n\n---\n\n[Document 3: onboarding/local-dev-setup.md]\n## Step 3: Set Up Local Services\n\n```bash\n# Start the local infrastructure stack (Postgres, Redis, Kafka, LocalStack)\ndocker-compose -f docker/docker-compose.local.yml up -d\n\n# Verify everything is running\nnovapay doctor\n```\n\nExpected output from `novapay doctor`:\n- PostgreSQL: `localhost:5432` \u2705\n- Redis: `localhost:6379` \u2705\n- Kafka: `localhost:9092` \u2705\n- LocalStack (S3/SQS): `localhost:4566` \u2705\n\n## Step 4: Seed the Database\n\n```bash\nnovapay db:migrate\nnovapay db:seed\n```\n\nThis creates test merchants and sample transaction data.\n\n## Step 5: Start Services\n\n```bash\n# Start all services in development mode\nnovapay dev\n\n# Or start specific services\nnovapay dev --service payments-api\nnovapay dev --service users-api\nnovapay dev --service gateway\n```\n\n## Service Ports (Local Dev)\n\n| Service | Port |\n|---------|------|\n| API Gateway | 8080 |\n| Payments API | 8001 |\n| Users API | 8002 |\n| Notifications API | 8003 |\n| Dashboard (frontend) | 3000 |\n| Admin Panel | 3001 |\n\n---\n\n[Document 4: onboarding/first-week-checklist.md]\n# First Week Checklist\n\n*Last updated: November 2024*\n\nWelcome to the NovaPay engineering team! Here's everything you need to get done in your first week.\n\n## Day 1 \u2014 Access & Setup\n\n- [ ] Get your NovaPay email set up (IT will have credentials ready)\n- [ ] Set up 1Password and enroll in SSO via Okta\n- [ ] Join the required Slack channels: `#engineering`, `#dev-environment`, `#incidents`, `#deploy-notifications`\n- [ ] Get added to the `novapay` GitHub org \u2014 ask your manager or ping `#it-help`\n- [ ] Clone the monorepo and follow the [Local Dev Setup](./local-dev-setup.md) guide\n- [ ] Install recommended VS Code extensions (list in `.vscode/extensions.json` in the repo)"
    },
    "outputs": {
      "answer": "Install prerequisites (Docker Desktop 4.25+, Node.js 20 LTS, Python 3.11+, Go 1.21+, AWS CLI v2), clone the monorepo, install the NovaPay CLI and run novapay bootstrap. Then start the local infra stack with docker-compose, run novapay doctor to verify, seed the database with novapay db:migrate and db:seed, and start services with novapay dev."
    }
  },
  {
    "inputs": {
      "question": "What happens during a database failover?",
      "context": "[Document 1: runbooks/database-failover.md]\n## Automatic Failover\n\nRDS Multi-AZ handles most failover scenarios automatically. When the primary fails:\n\n1. RDS detects the failure (typically within 30 seconds)\n2. DNS endpoint flips to the standby instance\n3. New primary is available (total downtime: 1-3 minutes)\n4. Applications reconnect automatically via connection pooling\n\n**You usually don't need to do anything.** The failover is automatic. Monitor and verify.\n\n---\n\n[Document 2: runbooks/database-failover.md]\n# Runbook: Database Failover\n\n*Owner: Platform Team (`#team-platform`)*\n*Severity: SEV-1 if primary DB is down; SEV-2 if replica lag*\n*Last tested: November 2024*\n\n## Overview\n\nNovaPay uses Amazon RDS for PostgreSQL with Multi-AZ deployments. We have three main database clusters:\n\n| Cluster | Endpoint | Purpose |\n|---------|----------|---------|\n| `payments-db` | `payments-db.cluster-abc123.us-east-1.rds.amazonaws.com` | Payment transactions, merchant data |\n| `users-db` | `users-db.cluster-def456.us-east-1.rds.amazonaws.com` | User accounts, API keys, sessions |\n| `analytics-db` | `analytics-db.cluster-ghi789.us-east-1.rds.amazonaws.com` | Read replicas for analytics queries |\n\nEach cluster has a primary writer instance and two read replicas in different AZs.\n\n---\n\n[Document 3: runbooks/database-failover.md]\n## Monitoring\n\n- **Datadog dashboard**: \"RDS Database Health\" (link in `#platform-dashboards` pinned messages)\n- **Alerts**: Configured for replica lag > 10s, connection count > 80%, CPU > 90%, storage > 85%\n- **CloudWatch**: RDS performance insights for query-level analysis\n\n## Important Notes\n\n- **Never manually promote a read replica** unless directed by Platform team lead. Promotion is irreversible and creates a new standalone instance.\n- After any failover event, verify that the connection pooler (PgBouncer) has refreshed its connections.\n- All database credentials are stored in AWS Secrets Manager and rotated every 90 days.\n- Database backups are taken every 6 hours with a retention period of 30 days.\n\n---\n\n[Document 4: runbooks/database-failover.md]\n## When Manual Intervention Is Needed\n\n### Scenario 1: Replica Lag > 30 seconds\n\n```bash\n# Check replica lag\naws rds describe-db-instances --db-instance-identifier payments-db-replica-1 \\\n  --query 'DBInstances[0].StatusInfos'\n```\n\nIf replica lag exceeds 30 seconds:\n1. Check for long-running queries on the primary: `SELECT * FROM pg_stat_activity WHERE state = 'active' AND query_start < now() - interval '5 minutes';`\n2. Check for large batch operations that might be causing write amplification\n3. If a specific query is the problem, consider killing it: `SELECT pg_cancel_backend(pid);`\n\n### Scenario 2: Failover Didn't Complete\n\nIf the automatic failover is stuck (status shows `failing-over` for > 5 minutes):\n\n```bash\n# Force a reboot with failover\naws rds reboot-db-instance \\\n  --db-instance-identifier payments-db-primary \\\n  --force-failover\n```"
    },
    "outputs": {
      "answer": "RDS Multi-AZ handles it automatically: detects the failure within 30 seconds, flips DNS to the standby, and the new primary is available in 1-3 minutes. Apps reconnect via connection pooling. Manual intervention is needed if replica lag exceeds 30 seconds or if failover gets stuck for more than 5 minutes. Important: never manually promote a read replica unless directed by the Platform team lead, and always verify PgBouncer has refreshed its connections after a failover."
    }
  },
  {
    "inputs": {
      "question": "What coding standards does NovaPay follow?",
      "context": "[Document 1: standards/coding-standards.md]\n# NovaPay Coding Standards\n\n*Last updated: October 2024*\n*Owner: Developer Experience Team (`#team-devex`)*\n\n## General Principles\n\n1. **Readability over cleverness** \u2014 Code is read far more than it's written. Optimize for the reader.\n2. **Consistency over preference** \u2014 Follow the established patterns in the codebase, even if you'd do it differently.\n3. **Test what matters** \u2014 We aim for 80%+ code coverage, but prioritize testing complex business logic over boilerplate.\n4. **Fail fast, fail loud** \u2014 Return errors early, log them with context, and don't swallow exceptions.\n\n---\n\n[Document 2: architecture/system-overview.md]\n# NovaPay System Architecture Overview\n\n*Last updated: August 2024*\n*Owner: Platform Team (`#team-platform`)*\n\n---\n\n[Document 3: architecture/system-overview.md]\n## High-Level Architecture\n\nNovaPay runs a microservice architecture on AWS, deployed to EKS (Elastic Kubernetes Service) across three availability zones in `us-east-1`. We process approximately 2 million payment transactions per day.\n\n---\n\n[Document 4: standards/api-design-guidelines.md]\n## Webhooks\n\nFor webhook delivery, follow these standards:\n- Sign payloads with HMAC-SHA256 using the merchant's webhook secret\n- Include a `NovaPay-Signature` header with the signature\n- Include a `NovaPay-Timestamp` header for replay protection\n- Retry failed deliveries with exponential backoff (see [Notifications API](../api/notifications-api.md))\n- Allow merchants to configure multiple webhook endpoints per event type\n\n## Documentation\n\nAll APIs must have:\n- OpenAPI 3.0 spec in the service's repo (`docs/openapi.yaml`)\n- Published documentation on the developer portal\n- Code examples in at least Python and JavaScript\n- A changelog documenting all changes per version"
    },
    "outputs": {
      "answer": "NovaPay's four core principles are: readability over cleverness, consistency over preference, test what matters (80%+ coverage target focused on business logic), and fail fast/fail loud. There are also language-specific standards for Go (golangci-lint, error wrapping), Python (ruff, type hints, pydantic), and TypeScript (strict mode, eslint, zod). The context only covers the general principles — the full language-specific details are in the coding standards doc."
    }
  },
  {
    "inputs": {
      "question": "How do I handle a payments service outage?",
      "context": "[Document 1: runbooks/payments-service-down.md]\n# Runbook: Payments Service Down\n\n*Owner: Payments Team (`#team-payments`)*\n*Severity: SEV-1 \u2014 All payment processing is halted*\n*Last tested: December 2024*\n\n## Symptoms\n\n- Datadog alert: `payments-api.health_check CRITICAL`\n- Merchants reporting `503 Service Unavailable` on payment endpoints\n- Dashboard showing spike in failed transactions\n- PagerDuty incident triggered for Payments on-call\n\n---\n\n[Document 2: runbooks/payments-service-down.md]\n### 3. Kafka Consumer Lag\n**Symptoms**: Payments are accepted but not processing. Kafka consumer lag is high.\n\n**Fix:**\n```bash\n# Check consumer lag\nkafka-consumer-groups.sh --bootstrap-server kafka.novapay.internal:9092 \\\n  --group payments-processor --describe\n\n# If lag > 10000, scale up consumers\nkubectl scale deployment/payments-processor -n payments --replicas=10\n```\n\n### 4. Upstream Provider Outage\n**Symptoms**: Logs show timeouts to `processor.stripe.com` or `api.adyen.com`\n\n**Fix**: This is outside our control. Enable the fallback processor:\n```bash\nnovapay config set payments.fallback_processor=true\n```\n\n---\n\n[Document 3: runbooks/high-latency-debugging.md]\n## Step 3: Quick Mitigations\n\n| Issue | Quick Fix | Permanent Fix |\n|-------|-----------|---------------|\n| Slow query | Kill the query, add index | Optimize query, add to slow query log |\n| Cache miss storm | Warm the cache manually | Fix cache key generation |\n| High pod CPU | Scale up replicas | Profile and optimize hot paths |\n| Kafka lag | Scale consumers | Optimize consumer processing |\n\n## Alerting Thresholds\n\n| Metric | Warning | Critical |\n|--------|---------|----------|\n| p50 latency | > 200ms | > 500ms |\n| p99 latency | > 1000ms | > 2000ms |\n| Error rate | > 1% | > 5% |\n| DB query time | > 100ms avg | > 500ms avg |\n\n## Escalation\n\n- If latency affects payments processing: Escalate to SEV-1 and follow the [Payments Service Down](./payments-service-down.md) runbook\n- If database-related: Ping Platform team on-call\n- If network-related: Contact AWS Support via the Support Console\n\n---\n\n[Document 4: runbooks/payments-service-down.md]\n## Escalation\n\n- If not resolved in 15 minutes: Page the Payments team lead (Sarah Chen)\n- If not resolved in 30 minutes: Page VP Engineering (Jamie Torres)\n- If database-related: Page Platform team on-call\n- Update the status page at `status.novapay.com` via the StatusPage dashboard\n\n## Post-Incident\n\n- Create a post-mortem doc within 48 hours (template in Notion)\n- Schedule a post-mortem review meeting within 1 week\n- File follow-up tickets for any action items\n- Update this runbook if the root cause was new"
    },
    "outputs": {
      "answer": "This is a SEV-1 incident. Common root causes include Kafka consumer lag (scale up consumers), upstream provider outages (enable fallback processor), and database connection pool exhaustion. Escalate to the Payments team lead after 15 minutes, VP Engineering after 30. Update the status page at status.novapay.com. After resolution, create a post-mortem within 48 hours."
    }
  },
  {
    "inputs": {
      "question": "What teams are part of NovaPay engineering?",
      "context": "[Document 1: onboarding/team-structure.md]\n# NovaPay Engineering Team Structure\n\n*Last updated: December 2024*\n\nNovaPay engineering is organized into five main teams, plus a few cross-cutting functions. We're about 200 engineers total across all teams.\n\n---\n\n[Document 2: architecture/system-overview.md]\n# NovaPay System Architecture Overview\n\n*Last updated: August 2024*\n*Owner: Platform Team (`#team-platform`)*\n\n---\n\n[Document 3: architecture/system-overview.md]\n## High-Level Architecture\n\nNovaPay runs a microservice architecture on AWS, deployed to EKS (Elastic Kubernetes Service) across three availability zones in `us-east-1`. We process approximately 2 million payment transactions per day.\n\n---\n\n[Document 4: standards/coding-standards.md]\n# NovaPay Coding Standards\n\n*Last updated: October 2024*\n*Owner: Developer Experience Team (`#team-devex`)*\n\n## General Principles\n\n1. **Readability over cleverness** \u2014 Code is read far more than it's written. Optimize for the reader.\n2. **Consistency over preference** \u2014 Follow the established patterns in the codebase, even if you'd do it differently.\n3. **Test what matters** \u2014 We aim for 80%+ code coverage, but prioritize testing complex business logic over boilerplate.\n4. **Fail fast, fail loud** \u2014 Return errors early, log them with context, and don't swallow exceptions."
    },
    "outputs": {
      "answer": "Five main teams: Payments (~50 engineers, lead Sarah Chen), Platform (~40, Marcus Johnson), Developer Experience (~15, Priya Patel), Risk & Compliance (~30, David Kim), and Growth & Merchant Experience (~35, Alex Rivera). About 200 engineers total. There are also cross-cutting SRE and Data Engineering functions."
    }
  }
]
